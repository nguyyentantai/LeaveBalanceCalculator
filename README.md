# LeaveBalanceCalculator

## Overview
LeaveBalanceCalculator is a JavaScript tool designed to help users track and calculate their leave balances based on a predefined leave policy. The tool monitors annual leave usage, handles carry-over of unused leave hours, accounts for additional leave based on years of service, and differentiates between regular leave and leisure days.

## Features
- **Annual Leave Tracking**: Monitors leave usage by year
- **Leave Balance Calculation**: Calculates available leave hours based on a standard policy (20 days/160 hours per year)
- **Carry-Over Management**: Tracks and calculates carry-over of unused leave hours from previous years
- **Service-Based Extra Leave**: Automatically adds extra leave hours based on years of service (8 hours for every 5 years)
- **Leave Categorization**: Distinguishes between regular annual leave and leisure days
- **Detailed Reporting**: Provides comprehensive console output showing leave balances and usage for each year

## How It Works
The calculator works by intercepting API calls to your organization's leave request system. When leave data is retrieved, the tool:

1. Resets previous calculations
2. Processes all leave requests and categorizes them by year and type
3. Calculates leave balances for each year, accounting for:
   - Standard annual leave allocation
   - Extra leave hours based on years of service
   - Carry-over hours from previous years
4. Displays detailed leave information in the browser console

## Installation

### Prerequisites
- Access to your organization's leave management system
- Basic understanding of browser developer tools

### Setup
1. Open your browser's developer console (F12 or Ctrl+Shift+I in most browsers)
2. Copy the entire content of `script.js`
3. Paste it into the console while on your leave management system's page
4. Press Enter to execute the script

### Quick Copy (One-click)
The repository ships with a minified build so teammates can copy everything from a single block on GitHub. The snippet below is generated by `npm run build` (see Development section) and matches `dist/leave-balance-calculator.min.js`. Click the copy button, paste it into the console, and hit Enter:

```javascript
const totalLeaveDays=20,hoursPerDay=8,totalLeaveHours=160,monthlyLeaveHours=13.333333333333334;let dateOfService=0,extraLeaveHours=0;const parseServiceDate=o=>!o||!/\d{2}\/\d{2}\/\d{4}/.test(o)?null:new Date(o.split("/").reverse().join("-")),getExtraLeaveHours=(o,a)=>{if(!o||!/\d{2}\/\d{2}\/\d{4}/.test(o))return console.log("Invalid year of service, set to 0"),0;const s=parseServiceDate(o);if(!s)return console.log("Invalid year of service, set to 0"),0;const n=a-s.getFullYear(),t=n>=0?n:0;return extraLeaveHours=t>=0?Math.floor(t/5)*8:0,extraLeaveHours},getBaseLeaveHours=(o,a)=>{const s=parseServiceDate(o);if(!s)return 160;const n=s.getFullYear();if(a<n)return 0;if(a>n)return 160;let t=12-s.getMonth();return s.getDate()>15&&(t-=1),t=Math.max(Math.min(t,12),0),Math.round(monthlyLeaveHours*t*100)/100},isCarryOverPossible=o=>{const a=new Date(o);return a<new Date(a.getFullYear(),2,31)&&a.getFullYear()>=2024},formatDaysAndHours=o=>{if(!Number.isFinite(o))return"0 days";const a=Math.round(o*100)/100,s=a<0,n=Math.abs(a),t=Math.floor(n/8),l=Math.round(n%8*100)/100,v=l>0?`${t} days ${l} hours`:`${t} days`;return s?`-${v}`:v},calculateLeaveSummary=(o,a)=>{const s={},n={},t={},l={},v={},g={},f={},p={};o.forEach(e=>{const c=new Date(e.start_date.split("/").reverse().join("-")).getFullYear();if(s[c]||(s[c]=0,n[c]=!1,t[c]=0,l[c]=0),e.leave_category_name==="Annual Leave (VN)"||e.leave_category_name==="Annual Leave"){s[c]+=e.total_units,e.leave_hours.forEach(i=>{if(isCarryOverPossible(i.date)){const u=parseFloat(i.hours);l[c]+=Number.isFinite(u)?u:0}});return}(e.leave_category_name==="Leisure Rules Day"||e.leave_category_name==="Leisure Rules Day (VN)")&&(n[c]=!0)});const r={},x=Object.keys(s).map(e=>parseInt(e,10)).sort((e,c)=>e-c);return x.forEach(e=>{const c=e-1,i=c>=2024&&t[c]||0,u=getBaseLeaveHours(a,e);v[e]=u;const y=getExtraLeaveHours(a,e);g[e]=y;const h=l[e]||0,d=Math.min(i,h);f[e]=d;const H=Math.max(i-d,0);p[e]=H;const L=s[e]-d,b=u+y-L;r[e]=b,t[e]=e>=2024&&b>0?b:0}),x.map(e=>{const c=s[e],i=n[e],u=e-1>=2024&&t[e-1]||0,y=f[e]||0,h=p[e]||0,d=g[e]||0,H=v[e]||0,D=r[e],L=e>=2024?Math.max(t[e]||0,0):0;return{year:e,baseLeaveHours:H,extraLeaveHours:d,leisureDayBooked:i,bookedHours:c,availableHours:D,carryOverFromPrevious:u,carryOverUsedBeforeExpiry:y,carryOverExpired:h,carryOverToNext:L}})},initLeaveBalanceCalculator=o=>{if(!o||typeof o.fetch!="function")return;const a=o.fetch;return o.fetch=(...s)=>{const n=a.apply(o,s);return n.then(async t=>{const l=t.url;if(l&&/\/api\/v3\/organisations\/\d+\/members\/\d+\/leave_requests/.test(l)){const f=await t.clone().json();calculateLeaveSummary(f.data.items,dateOfService).forEach(r=>{console.log(`Year ${r.year}:`),console.log(`- Annual Leave Entitlement: ${formatDaysAndHours(r.baseLeaveHours)}`),console.log(`- Extra Leave Hours: ${r.extraLeaveHours} hour(s)`),console.log(`- Booked Leisure day: ${r.leisureDayBooked}`),console.log(`- Booked Annual leaves: ${formatDaysAndHours(r.bookedHours)}`),console.log(`- Available Annual leaves: ${formatDaysAndHours(r.availableHours)}`),r.carryOverFromPrevious>0&&(console.log(`- Carry Over from ${r.year-1} (expires 31/03/${r.year}): ${formatDaysAndHours(r.carryOverFromPrevious)}`),console.log(`- Carry Over Used before 31/03/${r.year}: ${formatDaysAndHours(r.carryOverUsedBeforeExpiry)}`),console.log(`- Carry Over Expiring on 31/03/${r.year}: ${formatDaysAndHours(r.carryOverExpired)}`)),r.year>=2024&&console.log(`- Carry Over to ${Number(r.year)+1}: ${formatDaysAndHours(r.carryOverToNext)}`)})}}),n},typeof prompt=="function"?(dateOfService=prompt("Enter the start date of service (dd/mm/yyyy):"),console.log(`Date of service: ${dateOfService}`)):dateOfService="","Please change the item per page to see the results, better to set it to 100.Thank you!"};typeof window!="undefined"&&initLeaveBalanceCalculator(window),typeof module!="undefined"&&module.exports&&(module.exports={parseServiceDate,getExtraLeaveHours,getBaseLeaveHours,isCarryOverPossible,formatDaysAndHours,calculateLeaveSummary,initLeaveBalanceCalculator});
```

### Bookmarklet Option
Prefer a bookmark you can click on the leave page? Copy the content of `dist/leave-balance-calculator.bookmarklet.txt` (shown below) and create a new bookmark with the text as its URL:

```
javascript:(()=>{const totalLeaveDays=20,hoursPerDay=8,totalLeaveHours=160,monthlyLeaveHours=13.333333333333334;let dateOfService=0,extraLeaveHours=0;const parseServiceDate=o=>!o||!/\d{2}\/\d{2}\/\d{4}/.test(o)?null:new Date(o.split("/").reverse().join("-")),getExtraLeaveHours=(o,a)=>{if(!o||!/\d{2}\/\d{2}\/\d{4}/.test(o))return console.log("Invalid year of service, set to 0"),0;const s=parseServiceDate(o);if(!s)return console.log("Invalid year of service, set to 0"),0;const n=a-s.getFullYear(),t=n>=0?n:0;return extraLeaveHours=t>=0?Math.floor(t/5)*8:0,extraLeaveHours},getBaseLeaveHours=(o,a)=>{const s=parseServiceDate(o);if(!s)return 160;const n=s.getFullYear();if(a<n)return 0;if(a>n)return 160;let t=12-s.getMonth();return s.getDate()>15&&(t-=1),t=Math.max(Math.min(t,12),0),Math.round(monthlyLeaveHours*t*100)/100},isCarryOverPossible=o=>{const a=new Date(o);return a<new Date(a.getFullYear(),2,31)&&a.getFullYear()>=2024},formatDaysAndHours=o=>{if(!Number.isFinite(o))return"0 days";const a=Math.round(o*100)/100,s=a<0,n=Math.abs(a),t=Math.floor(n/8),l=Math.round(n%8*100)/100,v=l>0?`${t} days ${l} hours`:`${t} days`;return s?`-${v}`:v},calculateLeaveSummary=(o,a)=>{const s={},n={},t={},l={},v={},g={},f={},p={};o.forEach(e=>{const c=new Date(e.start_date.split("/").reverse().join("-")).getFullYear();if(s[c]||(s[c]=0,n[c]=!1,t[c]=0,l[c]=0),e.leave_category_name==="Annual Leave (VN)"||e.leave_category_name==="Annual Leave"){s[c]+=e.total_units,e.leave_hours.forEach(i=>{if(isCarryOverPossible(i.date)){const u=parseFloat(i.hours);l[c]+=Number.isFinite(u)?u:0}});return}(e.leave_category_name==="Leisure Rules Day"||e.leave_category_name==="Leisure Rules Day (VN)")&&(n[c]=!0)});const r={},x=Object.keys(s).map(e=>parseInt(e,10)).sort((e,c)=>e-c);return x.forEach(e=>{const c=e-1,i=c>=2024&&t[c]||0,u=getBaseLeaveHours(a,e);v[e]=u;const y=getExtraLeaveHours(a,e);g[e]=y;const h=l[e]||0,d=Math.min(i,h);f[e]=d;const H=Math.max(i-d,0);p[e]=H;const L=s[e]-d,b=u+y-L;r[e]=b,t[e]=e>=2024&&b>0?b:0}),x.map(e=>{const c=s[e],i=n[e],u=e-1>=2024&&t[e-1]||0,y=f[e]||0,h=p[e]||0,d=g[e]||0,H=v[e]||0,D=r[e],L=e>=2024?Math.max(t[e]||0,0):0;return{year:e,baseLeaveHours:H,extraLeaveHours:d,leisureDayBooked:i,bookedHours:c,availableHours:D,carryOverFromPrevious:u,carryOverUsedBeforeExpiry:y,carryOverExpired:h,carryOverToNext:L}})},initLeaveBalanceCalculator=o=>{if(!o||typeof o.fetch!="function")return;const a=o.fetch;return o.fetch=(...s)=>{const n=a.apply(o,s);return n.then(async t=>{const l=t.url;if(l&&/\/api\/v3\/organisations\/\d+\/members\/\d+\/leave_requests/.test(l)){const f=await t.clone().json();calculateLeaveSummary(f.data.items,dateOfService).forEach(r=>{console.log(`Year ${r.year}:`),console.log(`- Annual Leave Entitlement: ${formatDaysAndHours(r.baseLeaveHours)}`),console.log(`- Extra Leave Hours: ${r.extraLeaveHours} hour(s)`),console.log(`- Booked Leisure day: ${r.leisureDayBooked}`),console.log(`- Booked Annual leaves: ${formatDaysAndHours(r.bookedHours)}`),console.log(`- Available Annual leaves: ${formatDaysAndHours(r.availableHours)}`),r.carryOverFromPrevious>0&&(console.log(`- Carry Over from ${r.year-1} (expires 31/03/${r.year}): ${formatDaysAndHours(r.carryOverFromPrevious)}`),console.log(`- Carry Over Used before 31/03/${r.year}: ${formatDaysAndHours(r.carryOverUsedBeforeExpiry)}`),console.log(`- Carry Over Expiring on 31/03/${r.year}: ${formatDaysAndHours(r.carryOverExpired)}`)),r.year>=2024&&console.log(`- Carry Over to ${Number(r.year)+1}: ${formatDaysAndHours(r.carryOverToNext)}`)})}}),n},typeof prompt=="function"?(dateOfService=prompt("Enter the start date of service (dd/mm/yyyy):"),console.log(`Date of service: ${dateOfService}`)):dateOfService="","Please change the item per page to see the results, better to set it to 100.Thank you!"};typeof window!="undefined"&&initLeaveBalanceCalculator(window),typeof module!="undefined"&&module.exports&&(module.exports={parseServiceDate,getExtraLeaveHours,getBaseLeaveHours,isCarryOverPossible,formatDaysAndHours,calculateLeaveSummary,initLeaveBalanceCalculator});})();
```

## Usage
1. After installing the script, you'll be prompted to enter your service start date in the format `dd/mm/yyyy`
2. Navigate to your leave requests page in the leave management system
3. Adjust the "items per page" setting to a higher value (100 is recommended) to ensure all leave data is loaded
4. The script automatically intercepts the leave data and displays calculated balances in the console
5. Check the console output for:
   - Extra leave hours based on years of service
   - Booked leisure days
   - Booked annual leaves (in days and hours)
   - Available annual leaves (in days and hours)
   - Available carried-over annual leaves (for years after 2024)

## Understanding the Results
The console output provides a year-by-year breakdown of your leave balance:

```
Year 2023:
- Extra Leave Hours: 8 hour(s)
- Booked Leisure day: true
- Booked Annual leaves: 15 days 4 hours
- Available Annual leaves: 5 days 4 hours

Year 2024:
- Extra Leave Hours: 8 hour(s)
- Booked Leisure day: false
- Booked Annual leaves: 10 days
- Available Annual leaves: 10 days 
- Available Carried Over Annual leaves: 5 days 4 hours
```

## Leave Policy Details
- Standard annual leave: 20 days (160 hours) per year
- Extra leave: 1 day (8 hours) added for every 5 years of service
- Carry-over: Unused leave hours can be carried over to the next year (for years 2024 onward)
- Leave is tracked in both days and hours (8 hours = 1 day)

## Notes
- The calculator only works when accessing your organization's leave management system
- Results are displayed in the browser console and are not stored between sessions
- For accurate results, ensure all leave requests are properly loaded in the system
- The tool is particularly useful for tracking carry-over hours which apply from 2024 onward

## Troubleshooting
If you don't see any results:
1. Make sure you've entered your service date correctly
2. Increase the "items per page" setting to load all leave requests
3. Check that you're on the correct page in your leave management system
4. Verify that the console doesn't show any JavaScript errors

## Development
- `npm install` — installs the esbuild dependency used for bundling
- `npm test` — runs the Node-based regression test against `sample.json`
- `npm run build` — regenerates the minified script and bookmarklet under `dist/`. Update the README blocks after running this command so teammates always copy the latest build.

---

*This tool is designed for personal use and does not modify any data in your organization's leave management system.*
